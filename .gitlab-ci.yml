image: maven:3.9-eclipse-temurin-21

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  IMAGE_TAG_BACKEND: $CI_REGISTRY_IMAGE/backend:latest
  IMAGE_TAG_FRONTEND: $CI_REGISTRY_IMAGE/frontend:latest

cache:
  paths:
    - .m2/repository

stages:
  - test
  - package
  - integration_testBruno
  - build_images
  - deploy

test_job:
  stage: test
  script:
    - cd backend
    - echo "üß™ Lancement des tests unitaires..."
    - mvn test
  artifacts:
    when: always
    reports:
      junit: backend/target/surefire-reports/TEST-*.xml
  rules:
    - changes:
        - backend/**/*
        - pom.xml

build_jar_job:
  stage: package
  script:
    - cd backend
    - echo "üì¶ Cr√©ation du fichier JAR final..."
    - mvn package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 week
  rules:
    - changes:
        - backend/**/*
        - pom.xml
        - bruno_tests/**/*
bruno_test_job:
  stage: integration_testBruno
  script:
    - echo "üîß Installation de Node.js et Bruno CLI..."
    - 'apt-get update && apt-get install -y curl'
    - 'curl -fsSL https://deb.nodesource.com/setup_20.x | bash -'
    - 'apt-get install -y nodejs'
    - 'node -v'
    - 'npm install -g @usebruno/cli'
    - 'echo "üöÄ D√©marrage du serveur Spring Boot (Profil: TEST)..."'
    - 'nohup java -jar backend/target/*.jar --spring.profiles.active=test > app.log 2>&1 &'
    - echo "‚è≥ Attente du d√©marrage (30s)..."
    - 'sleep 30'
    - 'cat app.log'
    - echo "ü§ñ Ex√©cution des tests Bruno..."
    - 'cd bruno_tests'
    - 'bru run --env CI --reporter-junit results.xml'
  artifacts:
    when: always
    reports:
      junit: bruno_tests/results.xml
  rules:
    - changes:
        - backend/**/*
        - pom.xml
        - bruno_tests/**/*

docker_build_backend:
  stage: build_images
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - echo "üê≥ Login au registre GitLab..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "üî® Construction de l'image Backend..."
    - docker build -f backend/Dockerfile -t $IMAGE_TAG_BACKEND .
    - echo "‚¨ÜÔ∏è Envoi vers le registre..."
    - docker push $IMAGE_TAG_BACKEND
  rules:
    - if: $CI_COMMIT_BRANCH == "ressources_commun"
      changes:
        - backend/**/*
        - pom.xml

docker_build_frontend:
  stage: build_images
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - echo "üê≥ Login au registre GitLab..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "üî® Construction de l'image Frontend..."
    - cd frontend
    - docker build --build-arg VITE_API_URL=$VITE_API_URL -t $IMAGE_TAG_FRONTEND .
    - echo "‚¨ÜÔ∏è Envoi vers le registre..."
    - docker push $IMAGE_TAG_FRONTEND
  rules:
    - if: $CI_COMMIT_BRANCH == "ressources_commun"
      changes:
        - frontend/**/*
deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$Cipe_SSH_PRIVATE_KEY" | wc -c
    - echo "$Cipe_SSH_PRIVATE_KEY" | head -n 1
    - echo "$Cipe_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Connexion au VPS pour d√©ploiement..."
    - ssh $SSH_USER@$SSH_HOST "sudo /usr/local/bin/deploy.sh '$CI_REGISTRY_USER' '$CI_JOB_TOKEN' '$CI_REGISTRY'"
  rules:
    - if: $CI_COMMIT_BRANCH == "ressources_commun"
      changes:
        - frontend/**/*
        - backend/**/*
        - pom.xml
