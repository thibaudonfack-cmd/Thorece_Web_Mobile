@startuml Sequence_PublishBook_CipeStudio

actor Auteur
participant "VisualEditor\n(Frontend)" as Frontend
participant "PageController\n(Backend)" as Controller
participant "PageService" as Service
participant "BookService" as BookService
participant "SeaweedFStorageService" as Storage
participant "PageRepository" as PageRepo
participant "BookRepository" as BookRepo
database "SeaweedFS\n(S3)" as S3

== Sauvegarde du contenu draft (pendant l'édition) ==
Auteur -> Frontend: Édite le contenu\ndans TuesdayJS
Frontend -> Frontend: handleSaveToBackend\n(content, 'DRAFT')
Frontend -> Controller: PUT /page/{bookId}/content\n{bookContent: {...}, bookStatus: 'DRAFT'}
activate Controller

Controller -> Service: updateBookContent(bookId, requestDTO)
activate Service

Service -> Service: getOrCreatePage(book)
note right: Gère les race conditions avec\ntry-catch DataIntegrityViolationException

Service -> PageRepo: findByBookId(bookId)
activate PageRepo
PageRepo --> Service: Page existante ou null
deactivate PageRepo

alt Page n'existe pas
    Service -> Service: Créer nouvelle Page
    Service -> PageRepo: save(newPage)
end

Service -> Storage: uploadJson(content, randomUUID)
activate Storage
Storage -> S3: PUT bucket/draft/{uuid}.json
S3 --> Storage: URL publique
deactivate Storage

alt Draft URL existante
    Service -> Storage: deleteFile(oldDraftUrl)
    note right: Suppression de l'ancien draft\npour économiser l'espace
end

Service -> Service: page.setDraftUrl(newUrl)
Service -> PageRepo: save(page)
Service --> Controller: BookContentResponseDTO
deactivate Service
Controller --> Frontend: 200 OK {s3Url, updatedAt}
deactivate Controller

Frontend --> Auteur: "Brouillon sauvegardé"

== Publication du livre ==
Auteur -> Frontend: Clique sur "Publier"
Frontend -> Frontend: handleSaveToBackend\n(content, 'PUBLISHED')
Frontend -> Controller: PUT /page/{bookId}/content\n{bookContent: {...}, bookStatus: 'PUBLISHED'}
activate Controller

Controller -> Service: updateBookContent(bookId, requestDTO)
activate Service

Service -> Service: getOrCreatePage(book)
Service -> PageRepo: findByBookId(bookId)
activate PageRepo
PageRepo --> Service: Page existante
deactivate PageRepo

== Upload du contenu publié avec structure ==
Service -> Service: timestamp = now()
Service -> Service: path = books/{bookId}/published/{timestamp}.json
Service -> Storage: uploadJson(content, path)
activate Storage
Storage -> S3: PUT bucket/books/{bookId}/published/{timestamp}.json
S3 --> Storage: URL publique (structurée)
deactivate Storage

Service -> Service: page.setPublishedUrl(newUrl)
Service -> PageRepo: save(page)

== Mise à jour du statut du livre ==
Service -> BookService: updateBookStatus(bookId, PUBLISHED)
activate BookService
BookService -> BookRepo: findById(bookId)
activate BookRepo
BookRepo --> BookService: Book
deactivate BookRepo

BookService -> BookService: book.setStatus(PUBLISHED)
BookService -> BookRepo: save(book)
activate BookRepo
BookRepo --> BookService: OK
deactivate BookRepo
deactivate BookService

Service --> Controller: BookContentResponseDTO
deactivate Service
Controller --> Frontend: 200 OK {s3Url, updatedAt}
deactivate Controller

Frontend --> Auteur: "Livre publié avec succès !\nIl est maintenant visible\npar les éditeurs"

== Conséquences de la publication ==
note over Auteur, S3
  Le livre publié apparaît maintenant dans:
  1. Le catalogue des éditeurs (/editor/catalog)
  2. Les éditeurs peuvent l'ajouter à leurs collections
  3. Une fois dans une collection, il devient visible
     dans la bibliothèque publique des enfants
end note

@enduml
