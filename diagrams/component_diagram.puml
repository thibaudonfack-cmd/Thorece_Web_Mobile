@startuml Component_Diagram_CipeStudio

skinparam componentStyle rectangle

package "Frontend (React)" {
  component "App Router" as Router {
    [React Router v7]
    [Route Protection]
  }

  component "State Management" {
    [React Query\n(Server State)]
    [AuthContext\n(Global Auth State)]
    [Local State\n(useState, useReducer)]
  }

  package "Features" {
    component [Auth Feature\n(Login, Register, OTP)]
    component [Story Feature\n(Éditeur, Manager)]
    component [Child Feature\n(Library, Characters)]
    component [Editor Feature\n(Collections, Catalog)]
    component [Admin Feature\n(Users, Reports)]
    component [Minigames Feature]
  }

  component "Services" {
    [auth.service.js\n(fetchWithAuth)]
    [story.service.js]
    [child.service.js]
    [editor.service.js]
    [admin.service.js]
  }

  component "UI Components" {
    [Button, Input, Card]
    [LoadingState]
    [ErrorBoundary]
    [TuesdayJsReaderWrapper]
  }
}

package "Backend (Spring Boot)" {
  component "Security Layer" {
    [SecurityConfig]
    [JwtUtils]
    [ProtectedRoute Middleware]
  }

  component "Controllers" {
    [UserController\n(/auth/*, /users/*)]
    [BookController\n(/books/*)]
    [PageController\n(/page/*)]
    [CollectionController\n(/collections/*)]
    [ReportController\n(/reports/*)]
    [RefreshTokenController\n(/refresh)]
  }

  component "Services" {
    [UserService]
    [BookService]
    [PageService]
    [CollectionService]
    [ReportService]
    [EmailService]
    [SeaweedFStorageService]
    [RefreshTokenService]
  }

  component "Repositories" {
    [UserRepository\n(Spring Data JPA)]
    [BookRepository]
    [PageRepository]
    [CollectionRepository]
    [ReadingProgressRepository]
    [ReportRepository]
  }

  component "Security Beans" {
    [BookSecurity]
    [CollectionSecurity]
    [PageSecurity]
  }

  component "DTOs & Mappers" {
    [Request DTOs]
    [Response DTOs]
    [MapStruct Mappers]
  }
}

database "MySQL Database" {
  [users table]
  [books table]
  [collections table]
  [pages table]
  [reading_progress table]
  [reports table]
  [refresh_tokens table]
}

cloud "SeaweedFS (S3)" {
  folder "Buckets" {
    [Images]
    [Book Content (JSON)]
  }
}

cloud "SMTP Server" {
  [Email Service\n(OTP, Reset Password)]
}

' Relations Frontend
Router --> [Auth Feature]
Router --> [Story Feature]
Router --> [Child Feature]
Router --> [Editor Feature]
Router --> [Admin Feature]

[Auth Feature] --> [auth.service.js\n(fetchWithAuth)]
[Story Feature] --> [story.service.js]
[Child Feature] --> [child.service.js]
[Editor Feature] --> [editor.service.js]
[Admin Feature] --> [admin.service.js]

[React Query\n(Server State)] --> Services
[AuthContext\n(Global Auth State)] --> [auth.service.js\n(fetchWithAuth)]

' Relations Backend
[SecurityConfig] --> Controllers
Controllers --> Services
Services --> Repositories
Services --> [SeaweedFStorageService]
Services --> [EmailService]
Repositories --> "MySQL Database"

[BookSecurity] --> [BookRepository]
[CollectionSecurity] --> [CollectionRepository]
[PageSecurity] --> [PageRepository]

[ProtectedRoute Middleware] --> [BookSecurity]
[ProtectedRoute Middleware] --> [CollectionSecurity]
[ProtectedRoute Middleware] --> [PageSecurity]

[JwtUtils] --> [ProtectedRoute Middleware]

Controllers --> [DTOs & Mappers]
[DTOs & Mappers] --> Services

' Services externes
[SeaweedFStorageService] --> "SeaweedFS (S3)"
[EmailService] --> "SMTP Server"

' Communication Frontend-Backend
Services -up-> Controllers : REST API\nJSON

note right of "Frontend (React)"
  Architecture Feature-Based :
  Chaque feature est autonome avec
  ses propres composants, pages,
  services et hooks.
end note

note left of "Backend (Spring Boot)"
  Architecture en couches :
  Controller → Service → Repository

  Sécurité à plusieurs niveaux :
  1. JWT (authentification)
  2. Rôles (autorisation globale)
  3. Beans de sécurité (autorisation fine)
end note

note bottom of "MySQL Database"
  Base de données relationnelle
  avec contraintes d'intégrité
  référentielle (foreign keys).

  Optimisations :
  - Formules Hibernate (@Formula)
  - Lazy loading
  - Indexes automatiques
end note

@enduml
