@startuml Backend_Layered_Architecture

skinparam componentStyle rectangle

!define LIGHTBLUE #E3F2FD
!define LIGHTGREEN #E8F5E9
!define LIGHTYELLOW #FFF9C4
!define LIGHTPINK #FCE4EC

package "Client Layer" {
  actor "Client\n(Browser/Mobile)" as Client
}

package "Presentation Layer (Controllers)" LIGHTBLUE {
  component [UserController] as UC
  component [BookController] as BC
  component [PageController] as PC
  component [CollectionController] as CC
  component [ReportController] as RC

  note right of UC
    **Responsabilités** :
    • Validation des entrées (DTO)
    • Gestion des erreurs HTTP
    • Mapping Request → DTO
    • Mapping DTO → Response
    • Documentation OpenAPI/Swagger
  end note
}

package "Security Layer" LIGHTYELLOW {
  component [SecurityConfig] as SecConf
  component [JwtUtils] as JWT
  component [ProtectedRoute] as PR
  component [BookSecurity] as BS
  component [CollectionSecurity] as CS
  component [PageSecurity] as PS

  note right of SecConf
    **Sécurité multi-niveaux** :
    1. JWT (authentification)
    2. Rôles (autorisation globale)
    3. Beans de sécurité (autorisation fine)
  end note
}

package "Business Layer (Services)" LIGHTGREEN {
  component [UserService] as US
  component [BookService] as BookS
  component [PageService] as PageS
  component [CollectionService] as CollS
  component [ReportService] as RepS
  component [EmailService] as EmailS
  component [SeaweedFStorageService] as StorS
  component [RefreshTokenService] as TokenS

  note right of US
    **Logique métier** :
    • Règles de gestion
    • Orchestration des opérations
    • Validation métier
    • Transactions @Transactional
    • Gestion des erreurs métier
  end note
}

package "Data Access Layer (Repositories)" LIGHTPINK {
  component [UserRepository] as UR
  component [BookRepository] as BR
  component [PageRepository] as PageR
  component [CollectionRepository] as CR
  component [ReadingProgressRepository] as RR
  component [ReportRepository] as RepR
  component [RefreshTokenRepository] as TR

  note right of UR
    **Spring Data JPA** :
    • Requêtes dérivées
    • JPQL personnalisées
    • Pagination & Sorting
    • Projections & Specifications
  end note
}

package "External Services" {
  database "MySQL\n8.0" as DB
  cloud "SeaweedFS\n(S3)" as S3
  cloud "SMTP\nServer" as SMTP
}

' Relations verticales (flux descendant)
Client --> UC : HTTP/REST
Client --> BC
Client --> PC
Client --> CC
Client --> RC

UC --> US
BC --> BookS
PC --> PageS
CC --> CollS
RC --> RepS

US --> UR
BookS --> BR
PageS --> PageR
CollS --> CR
RepS --> RepR

UR --> DB
BR --> DB
PageR --> DB
CR --> DB
RR --> DB
RepR --> DB
TR --> DB

' Relations de sécurité
SecConf -down-> UC
SecConf -down-> BC
SecConf -down-> PC
SecConf -down-> CC
SecConf -down-> RC

JWT --> PR
PR --> BS
PR --> CS
PR --> PS

BS --> BR
CS --> CR
PS --> PageR

' Services externes
EmailS --> SMTP
StorS --> S3
PageS --> StorS
BookS --> StorS

' Transactions
US --> TokenS
US --> EmailS

note bottom of DB
  **Optimisations base de données** :
  • Connection pooling (HikariCP)
  • Lazy loading des relations
  • Batch fetching (@BatchSize)
  • Query hints
  • Indexes stratégiques
end note

note bottom of S3
  **Stratégie de stockage S3** :
  • Images : /images/{hash}.{ext}
  • Contenu draft : /draft/{uuid}.json
  • Contenu publié : /books/{id}/published/{timestamp}.json
  • Déduplication par hash SHA-512
end note

legend right
  **Principe de séparation des responsabilités** :

  1. **Controllers** : Point d'entrée HTTP, validation basique
  2. **Security** : Authentification, autorisation, contrôle d'accès
  3. **Services** : Logique métier, orchestration, transactions
  4. **Repositories** : Accès aux données, requêtes SQL

  **Avantages** :
  • Testabilité (chaque couche testable indépendamment)
  • Maintenabilité (responsabilités claires)
  • Évolutivité (modification d'une couche sans impacter les autres)
  • Réutilisabilité (services réutilisables)
endlegend

@enduml
