@startuml CICD_Pipeline_GitLab

!define LIGHTBLUE #E3F2FD
!define LIGHTGREEN #E8F5E9
!define LIGHTYELLOW #FFF9C4
!define LIGHTPINK #FCE4EC
!define LIGHTPURPLE #F3E5F5

skinparam activity {
  BackgroundColor LIGHTBLUE
  BorderColor #1976D2
  FontSize 12
}

|Development|
start
:Code Push\nto GitLab;
note right
  **Branches** :
  • main (production)
  • develop (staging)
  • feature/* (développement)
end note

|GitLab CI/CD|
:**Stage 1: Test**;
note right
  **Job: test_backend**
  • Image: maven:3.9.9-eclipse-temurin-21
  • Commande: ./mvnw test
  • Coverage: JaCoCo report
  • Durée: ~2-3 min

  **Artifacts** :
  • target/surefire-reports/
  • target/site/jacoco/
end note

partition "Tests Backend" LIGHTBLUE {
  :Install dependencies\n(Maven);
  :Run unit tests\n(JUnit 5);
  :Generate coverage\n(JaCoCo);

  if (Tests passed?) then (yes)
    :Publish test report;
  else (no)
    #FFB6C1:Pipeline failed;
    stop
  endif
}

:**Stage 2: Package**;
note right
  **Job: package_backend**
  • Image: maven:3.9.9-eclipse-temurin-21
  • Commande: ./mvnw clean package -DskipTests
  • Artifact: backend.jar
  • Durée: ~3-5 min
end note

partition "Build Backend" LIGHTGREEN {
  :./mvnw clean package;
  :Generate JAR\n(backend.jar);
  :Save artifact;
}

:**Stage 3: Integration Tests**;
note right
  **Job: integration_testBruno**
  • Image: node:22-alpine
  • Install: Bruno CLI (@usebruno/cli)
  • Backend: Start with java -jar backend.jar
  • Commande: bru run --env dev backend/bruno_collections
  • Durée: ~2-3 min
end note

partition "Integration Tests" LIGHTYELLOW {
  :Install Bruno CLI;
  :Start backend\n(background);
  :Wait for startup\n(health check);
  :Run Bruno tests\n(API tests);

  if (API tests passed?) then (yes)
    :Stop backend;
  else (no)
    #FFB6C1:Integration failed;
    stop
  endif
}

:**Stage 4: Build Images**;
note right
  **Job: build_backend_image**
  • Image: docker:latest
  • Services: docker:dind
  • Build: Multi-stage Dockerfile
  • Tag: gitlab.com/cipestudio/backend:latest
  • Push: GitLab Container Registry

  **Job: build_frontend_image**
  • Build: Frontend avec Nginx
  • Tag: gitlab.com/cipestudio/frontend:latest
end note

partition "Docker Build" LIGHTPINK {
  fork
    :Build backend image\n(Multi-stage Dockerfile);
    :Tag: backend:latest;
    :Push to registry;
  fork again
    :Build frontend image\n(Vite build + Nginx);
    :Tag: frontend:latest;
    :Push to registry;
  end fork
}

:**Stage 5: Deploy**;
note right
  **Job: deploy_dev** (only: develop)
  • Environment: development
  • SSH to dev server
  • docker-compose pull
  • docker-compose up -d

  **Job: deploy_prod** (only: main, manual)
  • Environment: production
  • Manual approval required
  • Blue-Green deployment
  • Health check before switching
end note

if (Branch == main?) then (yes)
  partition "Production Deployment" LIGHTPURPLE {
    :Manual approval\nrequired;
    note right
      **Sécurité** :
      • Deployment manual pour prod
      • Rollback automatique si échec
      • Health check obligatoire
    end note
    :SSH to prod server;
    :Pull images;
    :Blue-Green deploy;
    :Health check;
    if (Health OK?) then (yes)
      :Switch traffic\nto new version;
      :Keep old version\nfor rollback;
    else (no)
      #FFB6C1:Rollback to\nprevious version;
      stop
    endif
  }
else (develop)
  partition "Development Deployment" LIGHTGREEN {
    :SSH to dev server;
    :docker-compose pull;
    :docker-compose up -d;
    :Health check;
  }
endif

|Notification|
:Notify team\n(Email/Slack);
stop

legend right
  **Configuration GitLab CI/CD (.gitlab-ci.yml)** :

  **Stages** :
  1. test (Tests unitaires backend)
  2. package (Build JAR)
  3. integration_testBruno (Tests API Bruno)
  4. build_images (Docker build & push)
  5. deploy (Déploiement dev/prod)

  **Variables d'environnement** :
  • CI_REGISTRY: gitlab.com
  • CI_REGISTRY_IMAGE: $CI_REGISTRY/$CI_PROJECT_PATH
  • DOCKER_HOST: tcp://docker:2375
  • MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD (secrets)
  • SEAWEEDFS_URL, SMTP_HOST, etc.

  **Optimisations** :
  • Cache Maven dependencies (.m2)
  • Cache npm dependencies (node_modules)
  • Docker layer caching
  • Parallel jobs (build backend + frontend)

  **Durée totale** : ~10-15 minutes
endlegend

note bottom
  **Améliorations futures** :
  • Ajouter stage "code_quality" (SonarQube)
  • Ajouter stage "security_scan" (OWASP Dependency Check)
  • Tests de performance (JMeter/k6)
  • Smoke tests après déploiement
  • Notifications Slack/Discord
  • Rollback automatique si erreur détectée
end note

@enduml
