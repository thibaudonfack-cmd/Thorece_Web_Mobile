@startuml Deployment_Strategies

!define LIGHTBLUE #E3F2FD
!define LIGHTGREEN #E8F5E9
!define LIGHTYELLOW #FFF9C4
!define LIGHTPINK #FCE4EC

' Blue-Green Deployment
package "Blue-Green Deployment" as BlueGreen {
  actor "Users" as U1
  component [Load Balancer] as LB1

  rectangle "Environment BLUE\n(Version actuelle v1.0)" as Blue LIGHTBLUE {
    component [Backend v1.0] as B1
    component [Frontend v1.0] as F1
    database [MySQL] as DB1
  }

  rectangle "Environment GREEN\n(Nouvelle version v1.1)" as Green LIGHTGREEN {
    component [Backend v1.1] as B2
    component [Frontend v1.1] as F2
    database [MySQL] as DB2
  }

  U1 --> LB1
  LB1 --> Blue : "100% traffic"
  LB1 -[dashed]-> Green : "0% traffic\n(tests internes)"

  DB1 -[hidden]- DB2

  note right of Blue
    **Étape 1 : État initial**
    • Blue = Production active (v1.0)
    • Green = Nouvelle version déployée (v1.1)
    • Load balancer pointe vers Blue
    • Tests sur Green (smoke tests)
  end note

  note right of Green
    **Étape 2 : Préparation**
    • Déploiement de v1.1 sur Green
    • Migration de base de données (si nécessaire)
    • Health checks
    • Tests de validation
  end note
}

package "Bascule Instantanée" as Switch {
  actor "Users" as U2
  component [Load Balancer] as LB2

  rectangle "Environment BLUE\n(Ancienne version v1.0)" as Blue2 LIGHTBLUE {
    component [Backend v1.0] as B3
    component [Frontend v1.0] as F3
  }

  rectangle "Environment GREEN\n(Nouvelle version v1.1)" as Green2 LIGHTGREEN {
    component [Backend v1.1] as B4
    component [Frontend v1.1] as F4
  }

  U2 --> LB2
  LB2 -[dashed]-> Blue2 : "0% traffic\n(standby pour rollback)"
  LB2 --> Green2 : "100% traffic"

  note right of Green2
    **Étape 3 : Switch**
    • Load balancer bascule vers Green
    • Switch instantané (< 1 seconde)
    • Blue reste en standby
    • Monitoring intensif
  end note

  note right of Blue2
    **Rollback immédiat si problème**
    • Blue reste actif 24-48h
    • Rollback en 1 clic si erreur
    • Pas de downtime
  end note
}

' Rolling Deployment
package "Rolling Deployment (Alternative)" as Rolling {
  actor "Users" as U3
  component [Load Balancer] as LB3

  rectangle "Instance 1\nv1.0 → v1.1" as I1 LIGHTYELLOW
  rectangle "Instance 2\nv1.0 → v1.1" as I2 LIGHTYELLOW
  rectangle "Instance 3\nv1.0 → v1.1" as I3 LIGHTYELLOW

  U3 --> LB3
  LB3 --> I1
  LB3 --> I2
  LB3 --> I3

  note bottom of Rolling
    **Rolling Deployment** :

    **Phase 1** : Instance 1 updated (v1.1)
    • Load balancer : 33% v1.1, 67% v1.0
    • Monitoring

    **Phase 2** : Instance 2 updated (v1.1)
    • Load balancer : 67% v1.1, 33% v1.0
    • Monitoring

    **Phase 3** : Instance 3 updated (v1.1)
    • Load balancer : 100% v1.1

    **Avantages** :
    • Pas besoin de doubler les ressources
    • Rollback progressif possible

    **Inconvénients** :
    • Versions mixtes temporaires
    • Plus lent que Blue-Green
    • Problèmes de compatibilité possibles
  end note
}

' Canary Deployment
package "Canary Deployment (Avancé)" as Canary {
  actor "Users (100%)" as U4
  component [Load Balancer\nIntelligent] as LB4

  rectangle "Production\nv1.0 (Stable)" as Prod LIGHTBLUE {
    component [Backend v1.0] as P1
  }

  rectangle "Canary\nv1.1 (Test)" as Can LIGHTYELLOW {
    component [Backend v1.1] as C1
  }

  U4 --> LB4
  LB4 --> Prod : "95% traffic"
  LB4 --> Can : "5% traffic\n(canary users)"

  note right of Can
    **Déploiement progressif** :

    **Phase 1** : 5% trafic sur v1.1
    • Utilisateurs "canary" (beta testers)
    • Monitoring métriques (erreurs, latence)

    **Phase 2** : 25% si OK
    **Phase 3** : 50% si OK
    **Phase 4** : 100% migration complète

    **Rollback automatique** :
    • Si taux d'erreur > seuil
    • Si latence > seuil
    • Alertes automatiques
  end note
}

legend right
  **Comparaison des stratégies de déploiement** :

  **Blue-Green (Recommandé pour Cipe Studio)** :
  ✅ Avantages :
  • Zero downtime garanti
  • Rollback instantané
  • Tests complets avant switch
  • Simple à comprendre et implémenter

  ❌ Inconvénients :
  • Besoin de doubler les ressources temporairement
  • Migration de base de données complexe

  **Rolling Deployment** :
  ✅ Avantages :
  • Pas de doublement de ressources
  • Progressif et contrôlable

  ❌ Inconvénients :
  • Versions mixtes temporaires
  • Rollback plus complexe

  **Canary Deployment** :
  ✅ Avantages :
  • Risques minimisés
  • Feedback utilisateur réel progressif
  • Rollback automatique

  ❌ Inconvénients :
  • Configuration complexe
  • Nécessite monitoring avancé
  • Pas adapté pour petites applications

  **Choix pour Cipe Studio** : Blue-Green
  • Simple à mettre en place avec Docker Compose
  • Rollback immédiat en cas de problème
  • Adapté à l'équipe réduite
endlegend

note bottom
  **Implémentation Blue-Green avec Docker Compose** :

  ```yaml
  # docker-compose.blue.yml
  services:
    backend-blue:
      image: cipestudio/backend:v1.0
      container_name: backend-blue
      ports:
        - "8080:8080"

  # docker-compose.green.yml
  services:
    backend-green:
      image: cipestudio/backend:v1.1
      container_name: backend-green
      ports:
        - "8081:8080"  # Port différent temporairement

  # Nginx config
  upstream backend {
    server backend-blue:8080;  # Active
    # server backend-green:8080;  # Standby
  }

  # Pour basculer :
  # 1. Commenter backend-blue
  # 2. Décommenter backend-green
  # 3. nginx -s reload
  ```

  **Script de déploiement** :
  ```bash
  #!/bin/bash
  # deploy-blue-green.sh

  # 1. Déployer nouvelle version sur Green
  docker-compose -f docker-compose.green.yml up -d

  # 2. Health check
  curl http://localhost:8081/health

  # 3. Si OK, switch Nginx
  # Mettre à jour nginx.conf
  # nginx -s reload

  # 4. Garder Blue actif 24h pour rollback
  # Après 24h : docker-compose -f docker-compose.blue.yml down
  ```
end note

@enduml
